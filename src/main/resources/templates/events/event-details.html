<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{base/layout}">

<head>
    <th:block layout:fragment="head-extra">
        <meta name="_csrf" th:content="${_csrf.token}" />
        <meta name="_csrf_header" th:content="${_csrf.headerName}" />
        <!-- 1. ADD THIS IN THE <head> SECTION (for auto-refresh) -->
        <!-- Add after existing meta tags and before stylesheets -->
        <meta th:if="${autoRefresh}" http-equiv="refresh" content="3">
        <style>
            /* Attendee avatar styles */
            .attendee-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background-color: #6c757d;
                color: white;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
            }

            /* Stub section styling */
            .stub-section {
                background: #f8f9fa;
                border: 1px dashed #dee2e6;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                color: #6c757d;
            }

            .stub-section i {
                font-size: 2rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            /* Capacity progress bar color based on percentage */
            .progress-bar-success {
                background-color: #28a745;
            }

            .progress-bar-warning {
                background-color: #ffc107;
            }

            .progress-bar-danger {
                background-color: #fd7e14;
            }

            /* Info grid styling */
            .info-grid .col-md-6 {
                margin-bottom: 1.5rem;
            }

            /* Modal backdrop z-index fix */
            .modal-backdrop {
                z-index: 1040;
            }

            /* Scrollable attendee list - allows showing unlimited attendees with vertical scroll */
            .attendee-list-container {
                max-height: 420px; /* Fixed height to show ~10 attendees @ 42px each (avatar + margins) */
                overflow-y: auto;   /* Show vertical scrollbar when content exceeds max-height */
                overflow-x: hidden; /* Hide horizontal scrollbar to prevent layout issues */
            }

            /* Custom scrollbar styling for webkit browsers (Chrome, Safari, Edge) */
            .attendee-list-container::-webkit-scrollbar {
                width: 6px; /* Thin scrollbar for clean appearance */
            }

            /* Scrollbar track (background rail) styling */
            .attendee-list-container::-webkit-scrollbar-track {
                background: #f1f1f1; /* Light gray background */
                border-radius: 3px;   /* Rounded corners to match UI */
            }

            /* Scrollbar thumb (draggable part) styling */
            .attendee-list-container::-webkit-scrollbar-thumb {
                background: #888;     /* Medium gray for visibility */
                border-radius: 3px;   /* Rounded corners to match track */
            }

            /* Scrollbar thumb hover state for better UX */
            .attendee-list-container::-webkit-scrollbar-thumb:hover {
                background: #555; /* Darker gray on hover for interaction feedback */
            }

            /* Keyword Badge Styles */
            .badge-outline {
                border: 2px solid;
                background-color: rgba(255, 255, 255, 0.9);
                padding: 0.35em 0.65em;
                font-weight: 500;
            }

            /* Organiser Controls hover text fix - ensure all buttons have black text on hover */
            #organizer-controls .btn:hover {
                color: #000 !important;
            }

            .rating-input {
                display: flex;
                flex-direction: row-reverse;
                justify-content: flex-end;
                font-size: 2rem;
            }
            .rating-input input[type="radio"] {
                display: none;
            }
            .rating-input label {
                color: #ccc;
                cursor: pointer;
            }
            .rating-input input[type="radio"]:checked ~ label,
            .rating-input label:hover,
            .rating-input label:hover ~ label {
                color: #ffc700;
            }

            /* Photo Gallery Styles */
            .photo-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .photo-item {
                position: relative;
                border-radius: 0.5rem;
                background: #f8f9fa;
                transition: transform 0.2s;
            }

            .photo-item:hover {
                transform: scale(1.02);
            }

            .photo-item img {
                width: 100%;
                aspect-ratio: 1;
                object-fit: cover;
                border-radius: 0.5rem;
                cursor: pointer;
            }


            .upload-area {
                border: 2px dashed #dee2e6;
                border-radius: 0.5rem;
                padding: 2rem;
                text-align: center;
                background: #f8f9fa;
                margin-bottom: 1rem;
            }

            .upload-area.drag-over {
                border-color: #0d6efd;
                background: #e7f1ff;
            }

            /* Lightbox Styles */
            .lightbox {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.95);
                z-index: 9999;
                justify-content: center;
                align-items: center;
            }

            .lightbox.active {
                display: flex;
            }

            .lightbox-content {
                position: relative;
                max-width: 90%;
                max-height: 90%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .lightbox-image {
                max-width: 100%;
                max-height: 85vh;
                object-fit: contain;
                border-radius: 0.5rem;
            }

            .lightbox-caption {
                color: white;
                margin-top: 1rem;
                text-align: center;
                font-size: 1rem;
            }

            .lightbox-close {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.5rem;
                transition: background 0.2s;
            }

            .lightbox-close:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .lightbox-nav {
                position: absolute;
                top: 50%;
                transform: translateY(-50%);
                background: rgba(255, 255, 255, 0.2);
                color: white;
                border: none;
                border-radius: 50%;
                width: 50px;
                height: 50px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 1.5rem;
                transition: background 0.2s;
            }

            .lightbox-nav:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .lightbox-nav.prev {
                left: 2rem;
            }

            .lightbox-nav.next {
                right: 2rem;
            }

            .lightbox-nav:disabled {
                opacity: 0.3;
                cursor: not-allowed;
            }

        </style>
    </th:block>
</head>

<body>
    <main layout:fragment="content">
        <div class="container my-4">
            <!-- Breadcrumb (static, non-clickable) -->
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">Home</li>
                    <li class="breadcrumb-item" th:text="${event.categoryName}">Category</li>
                    <li class="breadcrumb-item active" th:text="${event.title}">Event Title</li>
                </ol>
            </nav>

            <!-- Organizer Controls Section -->
            <div sec:authorize="isAuthenticated()" th:if="${event.createdByUsername == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}" class="card mb-3 border-warning" id="organizer-controls" style="font-size: 0.85rem;">
                <div class="card-header bg-warning bg-opacity-10 py-1">
                    <h5 class="mb-0"><i class="fas fa-user-cog me-1"></i>Organiser-only Controls</h5>
                </div>
                <div class="card-body py-2">
                    <!-- Single row with all buttons taking equal width -->
                    <div class="d-flex gap-1">
                        <!-- Edit Event -->
                        <button class="btn btn-outline-secondary btn-sm flex-fill" style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" onclick="alert('Edit functionality coming soon')">
                            <i class="fas fa-edit me-1"></i> <span style="text-decoration: line-through;">Edit</span>
                        </button>
            
                        <!-- Delete Event -->
                        <form method="post" th:action="@{/events/{id}/delete(id=${event.eventId})}"
                            onsubmit="return confirm('Are you sure you want to delete this event? This action cannot be undone.');"
                            class="flex-fill">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-outline-danger btn-sm w-100" style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);">
                                <i class="fas fa-trash me-1"></i> Delete
                            </button>
                        </form>
            
                        <!-- Export Attendees -->
                        <button class="btn btn-outline-info btn-sm flex-fill" 
                                style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" 
                                th:onclick="|exportAttendees(${event.eventId})|">
                            <i class="fas fa-file-csv me-1"></i> Export
                        </button>
            
                        <!-- QR Scanner -->
                        <button class="btn btn-outline-secondary btn-sm flex-fill" style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" onclick="alert('QR Scanner coming soon')">
                            <i class="fas fa-qrcode me-1"></i> <span style="text-decoration: line-through;">QR</span>
                        </button>
            
                        <!-- Send Announcement -->
                        <button class="btn btn-outline-secondary btn-sm flex-fill" style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" onclick="alert('Announcement feature coming soon')">
                            <i class="fas fa-bullhorn me-1"></i> <span style="text-decoration: line-through;">Announce</span>
                        </button>
            
                        <!-- Manage Attendees -->
                        <button class="btn btn-outline-primary btn-sm flex-fill"
                            style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" onclick="openAttendeesModal()"
                            data-event-id="${event.eventId}">
                            <i class="fas fa-users-cog me-1"></i> Attendees
                        </button>
            
                        <!-- Event Analytics -->
                        <button class="btn btn-outline-secondary btn-sm flex-fill" style="font-size: 0.75rem; background-color: rgba(13, 202, 240, 0.1);" onclick="alert('Analytics coming soon')">
                            <i class="fas fa-chart-bar me-1"></i> <span style="text-decoration: line-through;">Analytics</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Main Content Column -->
                <div class="col-lg-8">
                    <!-- Event Details Card -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Event Header -->
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h1 class="h3 mb-2" th:text="${event.title}">Event Title</h1>
                                    <p class="text-muted mb-0">
                                        Organized by <strong th:text="${event.createdByUsername}">Organizer</strong>
                                    </p>
                                </div>
                                <div>
                                    <span class="badge"
                                        th:style="|background-color: ${event.categoryColor}; color: white;|"
                                        th:text="${event.categoryName}">Category</span>
                                </div>
                            </div>

                            <!-- Keywords - Add this block after the creator/author info div -->
                            <div th:if="${event.keywords != null and !event.keywords.empty}" class="mb-3">
                                <div class="d-flex flex-wrap gap-2">
                                    <span th:each="keyword : ${event.keywords}"
                                          class="badge badge-outline"
                                          th:style="|border-color: ${keyword.color}; color: ${keyword.color}; background-color: ${keyword.color}20;|"
                                          th:text="${keyword.name}">Keyword</span>
                                </div>
                            </div>

                            <hr>

                            <!-- Event Info Grid -->
                            <div class="row info-grid mb-4">
                                <!-- Date -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar-alt text-primary me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Date</small><br>
                                            <strong
                                                th:text="${#temporals.format(event.eventDate, 'EEEE, MMMM d, yyyy')}">
                                                Saturday, January 12, 2025
                                            </strong>
                                        </div>
                                    </div>
                                </div>

                                <!-- Time -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-clock text-primary me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Time</small><br>
                                            <strong th:text="${#temporals.format(event.eventTime, 'h:mm a')}">
                                                3:00 PM
                                            </strong>
                                        </div>
                                    </div>
                                </div>

                                <!-- Location -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-map-marker-alt text-primary me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Location</small><br>
                                            <strong th:text="${event.location}">Building 14, Room 12</strong>
                                        </div>
                                    </div>
                                </div>

                                <!-- Capacity -->
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-users text-primary me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Capacity</small><br>
                                            <!-- Unlimited capacity -->
                                            <strong th:if="${event.maxAttendees == null}">
                                                <span th:text="${event.attendeeCount}">0</span> attendees
                                                <span class="badge bg-success ms-2">Open</span>
                                            </strong>
                                            <!-- Limited capacity -->
                                            <strong th:if="${event.maxAttendees != null}">
                                                <span
                                                    th:text="${event.attendeeCount + '/' + event.maxAttendees}">45/60</span>
                                                attendees
                                            </strong>
                                            <!-- Progress bar for limited capacity -->
                                            <div th:if="${event.maxAttendees != null}" class="progress mt-1"
                                                style="height: 5px;">
                                                <div class="progress-bar"
                                                    th:classappend="${event.attendeeCount < event.maxAttendees * 0.5 ? 'progress-bar-success' : (event.attendeeCount < event.maxAttendees * 0.8 ? 'progress-bar-warning' : 'progress-bar-danger')}"
                                                    th:style="'width: ' + ${(event.attendeeCount * 100.0 / event.maxAttendees)} + '%'">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Price -->
                                <div class="col-md-6">
                                    <!-- Paid Event (price >= $0.05) -->
                                    <div th:if="${event.price != null and event.price >= 0.05}" class="d-flex align-items-center">
                                        <i class="fas fa-dollar-sign text-success me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Price</small><br>
                                            <strong th:text="|$${#numbers.formatDecimal(event.price, 1, 2)}|">$25.00</strong>
                                            <span class="badge bg-warning ms-2">Paid Event</span>
                                        </div>
                                    </div>
                                    <!-- Free Event (price < $0.05 or null) -->
                                    <div th:if="${event.price == null or event.price < 0.05}" class="d-flex align-items-center">
                                        <i class="fas fa-ticket-alt text-info me-3 fa-lg"></i>
                                        <div>
                                            <small class="text-muted">Price</small><br>
                                            <span class="badge bg-info text-dark">Free Event</span>
                                        </div>
                                    </div>
                                </div>
                            </div> <!-- closes row info-grid mb-4 -->

                            <!-- Description -->
                            <div class="mb-4">
                                <h5><i class="fas fa-info-circle text-primary me-2"></i>About This Event</h5>
                                <p th:text="${event.fullDescription}" style="white-space: pre-wrap;">
                                    Event description goes here...
                                </p>
                            </div>

                            <!-- Tags Section (Empty for now) -->
                            <div class="mb-4">
                                <h5><i class="fas fa-tags text-primary me-2"></i>Tags</h5>
                                <p class="text-muted">No tags added yet</p>
                            </div>

                            <!-- Location Map (Stub) -->
                            <div class="mb-4">
                                <h5><i class="fas fa-map text-primary me-2"></i>Location Map</h5>
                                <div class="stub-section">
                                    <i class="fas fa-map-marked-alt"></i>
                                    <p class="mb-0">Interactive map coming soon</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Photo Gallery Card -->
                    <div class="card mb-4" th:if="${eventHasPassed}">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-images text-primary me-2"></i>Event Gallery</h5>
                                <span class="badge bg-secondary" id="photoCount">0/20 photos</span>
                            </div>
                        </div>
                        <div class="card-body">

                            <!-- Upload Section (Organizers/Admins only) -->
                            <div sec:authorize="isAuthenticated()"
                                 th:if="${event.createdByUsername == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}"
                                 class="mb-4">
                                <div class="upload-area" id="uploadArea">
                                    <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                                    <p class="mb-2">Drag & drop photos here or click to select</p>
                                    <input type="file"
                                           id="photoInput"
                                           accept="image/jpeg,image/png"
                                           multiple
                                           style="display: none;">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('photoInput').click()">
                                        <i class="fas fa-upload me-1"></i>Select Photos
                                    </button>
                                    <p class="text-muted mt-2 mb-0" style="font-size: 0.85rem;">
                                        Maximum 20 photos | JPEG/PNG only | 5MB max per file
                                    </p>
                                </div>
                            </div>

                            <!-- Photo Grid -->
                            <div id="photoGallery">
                                <!-- Photos will be loaded here dynamically -->
                            </div>

                            <!-- Empty State (shown when no photos and user has RSVP'd) -->
                            <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                                <i class="fas fa-images fa-3x mb-3" style="opacity: 0.3;"></i>
                                <p class="mb-0">No photos yet</p>
                            </div>

                            <!-- No RSVP State (shown when user hasn't RSVP'd AND is not organizer/admin) -->
                            <div th:unless="${didUserRsvp}"
                                 th:if="${!(event.createdByUsername == #authentication.name or #authorization.expression('hasRole(''ADMIN'')'))}">
                                <div class="stub-section">
                                    <i class="fas fa-lock"></i>
                                    <p class="mb-0">RSVP to this event to view the photo gallery</p>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Reviews Card -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><i class="fas fa-star text-warning me-2"></i>Reviews</h5>
                                
                                <span class="badge bg-primary" th:if="${totalReviews > 0}">
                                    <i class="fas fa-star"></i>
                                    <span th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">4.3</span>/5 
                                    (<span th:text="${totalReviews}">12</span> reviews)
                                </span>
                                <span class="badge bg-secondary" th:if="${totalReviews == 0}">
                                    No reviews yet
                                </span>
                            </div>
                        </div>
                        <div class="card-body">

                            <div th:if="${#lists.isEmpty(reviews)}">
                                <p>Be the first to leave a review for this event!</p>
                            </div>

                            <div th:if="${!#lists.isEmpty(reviews)}">
                                <div th:each="review : ${reviews}" class="border-bottom pb-3 mb-3">
                                    <div class="d-flex justify-content-between mb-2">
                                        <div>
                                            <strong th:text="${review.authorUsername}">Emily Watson</strong>
                                            <span class="badge bg-success ms-2">Verified Attendee</span>
                                        </div>
                                        <div class="rating">
                                            <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                                <i th:class="${i <= review.rating} ? 'fas fa-star' : 'far fa-star'"></i>
                                            </th:block>
                                        </div>
                                    </div>
                                    <p class="mb-1" th:text="${review.comment}">Excellent workshop! ...</p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock"></i> 
                                        <span th:text="${#temporals.format(review.createdAt, 'MMMM dd, yyyy')}">December 15, 2024</span>
                                    </small>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h6>Leave a Review</h6>

                                <th:block th:if="${eventHasPassed}">
                                    
                                    <th:block th:if="${didUserRsvp}">
                                    
                                        <div th:if="${userHasAlreadyReviewed}">
                                            <div class="stub-section text-center p-4">
                                                <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                                                <p class="mb-0">Thank you for your review!</p>
                                            </div>
                                        </div>
                                        
                                        <div th:unless="${userHasAlreadyReviewed}">

                                            <form th:action="@{/events/{eventId}/review(eventId=${event.eventId})}" th:object="${reviewDTO}" method="post">
                                                <div class="mb-3">
                                                    <label class="form-label">Your Rating</label>
                                                    <div class="rating-input">
                                                        <input type="radio" th:field="*{rating}" value="5" id="star5" required><label for="star5">★</label>
                                                        <input type="radio" th:field="*{rating}" value="4" id="star4"><label for="star4">★</label>
                                                        <input type="radio" th:field="*{rating}" value="3" id="star3"><label for="star3">★</label>
                                                        <input type="radio" th:field="*{rating}" value="2" id="star2"><label for="star2">★</label>
                                                        <input type="radio" th:field="*{rating}" value="1" id="star1"><label for="star1">★</label>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <textarea class="form-control" th:field="*{comment}" rows="3" 
                                                            placeholder="Share your experience..." required></textarea>
                                                </div>
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-paper-plane"></i> Submit Review
                                                </button>
                                            </form>
                                        </div>
                                        
                                    </th:block>

                                    <div th:unless="${didUserRsvp}">
                                        <div class="stub-section text-center p-4">
                                            <i class="fas fa-user-check fa-2x text-muted mb-3"></i>
                                            <p class="mb-0">Only attendees who RSVP'd can leave a review.</p>
                                        </div>
                                    </div>
                                    
                                </th:block>

                                <div th:unless="${eventHasPassed}">
                                    <div class="stub-section text-center p-4">
                                        <i class="fas fa-clock fa-2x text-muted mb-3"></i>
                                        <p class="mb-0">You can leave a review after the event has finished.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Column -->
                <div class="col-lg-4">
                    <!-- RSVP Status Card for Authenticated Users -->
                    <div sec:authorize="isAuthenticated()">
                        <!-- User is Going -->
                        <div th:if="${event.userRsvpStatus and !event.eventStarted}" class="card mb-3 border-success">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-check-circle text-success fa-3x"></i>
                                </div>
                                <h5 class="card-title text-success">You're Going!</h5>
                                <p class="text-muted mb-3">You have successfully RSVP'd to this event</p>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-success" disabled>
                                        <i class="fas fa-calendar"></i> Add to Calendar
                                    </button>
                                    <button class="btn btn-outline-danger" data-bs-toggle="modal"
                                        data-bs-target="#cancelModal">
                                        <i class="fas fa-times-circle"></i> Cancel RSVP
                                    </button>
                                </div>

                                <!-- Payment Status Section (Only for Paid Events) -->
                                <div th:if="${event.requiresPayment and event.price != null}" class="mt-3">
                                    <!-- Payment Pending - Show Pay Now Button -->
                                    <form th:if="${event.userPaymentStatus == 'pending'}"
                                          th:action="@{/api/payments/create-checkout-session}"
                                          method="post"
                                          id="paymentForm">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="eventId" th:value="${event.eventId}" />
                                        <input type="hidden" name="rsvpId" th:value="${event.userRsvpId}" />
                                        <button type="submit" class="btn btn-warning w-100">
                                            <i class="fas fa-credit-card"></i> Pay Now - $<span th:text="${event.price}">25.00</span>
                                        </button>
                                        <small class="text-muted d-block mt-1 text-center">Payment required to confirm attendance</small>
                                    </form>

                                    <!-- Payment Completed - Show Paid Badge -->
                                    <button th:if="${event.userPaymentStatus == 'paid'}"
                                            class="btn btn-success w-100"
                                            disabled>
                                        <i class="fas fa-check-circle"></i> Paid
                                    </button>
                                </div>

                                <hr>
                                <small class="text-muted">You'll receive a reminder 1 day before the event</small>
                            </div>
                        </div>

                        <!-- User Can RSVP -->
                        <div th:if="${!event.userRsvpStatus and !event.eventStarted and !event.eventFull and !event.userBlockedStatus}"
                            class="card mb-3 border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title">Join This Event</h5>
                                <p class="text-muted">
                                    <span th:text="${event.attendeeCount}">45</span> attendees registered
                                </p>
                                <form th:action="@{/rsvp/{id}(id=${event.eventId})}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        <i class="fas fa-calendar-check"></i> RSVP Now
                                    </button>
                                </form>
                                <small class="text-muted mt-2 d-block">
                                    Free Event •
                                    <span th:if="${event.maxAttendees != null}">
                                        <span th:text="${event.maxAttendees - event.attendeeCount}">15</span> spots
                                        remaining
                                    </span>
                                    <span th:if="${event.maxAttendees == null}">Unlimited spots</span>
                                </small>
                            </div>
                        </div>

                        <!-- User is Blocked -->
                        <div th:if="${!event.userRsvpStatus and !event.eventStarted and event.userBlockedStatus}"
                             class="card mb-3 border-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title text-warning">RSVP Blocked</h5>
                                <p class="text-muted">You have been blocked from RSVPing to this event.</p>
                                <button class="btn btn-secondary btn-lg w-100" disabled>
                                    <i class="fas fa-ban"></i> Contact Organizer
                                </button>
                                <small class="text-muted mt-2 d-block">
                                    Please contact the event organizer for more information.
                                </small>
                            </div>
                        </div>

                        <!-- Event is Full -->
                        <div th:if="${!event.userRsvpStatus and !event.eventStarted and event.eventFull}"
                            class="card mb-3 border-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title text-danger">Event Full</h5>
                                <p class="text-muted">This event has reached maximum capacity</p>
                                <button class="btn btn-secondary btn-lg w-100" disabled>
                                    <i class="fas fa-ban"></i> No Spots Available
                                </button>
                            </div>
                        </div>

                        <!-- Event Started -->
                        <div th:if="${event.eventStarted}" class="card mb-3 border-secondary">
                            <div class="card-body text-center">
                                <h5 class="card-title text-secondary">Event Has Started</h5>
                                <p class="text-muted">RSVPs are no longer available</p>
                            </div>
                        </div>
                    </div>

                    <!-- Login Prompt for Anonymous Users -->
                    <div sec:authorize="!isAuthenticated()" class="card mb-3 border-primary">
                        <div class="card-body text-center">
                            <h5 class="card-title">Want to Attend?</h5>
                            <p class="text-muted mb-3">Please login or register to RSVP for this event</p>
                            <div class="d-grid gap-2">
                                <a th:href="@{/login(returnUrl='/events/' + ${event.eventId})}" class="btn btn-primary">
                                    <i class="fas fa-sign-in-alt me-2"></i>Login
                                </a>
                                <a th:href="@{/register}" class="btn btn-outline-primary">
                                    <i class="fas fa-user-plus me-2"></i>Register
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Share Card (Stub) -->
                    <div class="card mb-3">
                        <div class="card-body">
                            <h6 class="card-title"><i class="fas fa-share-alt text-primary me-2"></i>Share Event</h6>
                            <div class="btn-group w-100" role="group">
                                <button class="btn btn-outline-primary btn-sm" disabled>
                                    <i class="fab fa-facebook"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" disabled>
                                    <i class="fab fa-twitter"></i>
                                </button>
                                <button class="btn btn-outline-success btn-sm" disabled>
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" disabled>
                                    <i class="fas fa-link"></i>
                                </button>
                            </div>
                            <small class="text-muted d-block mt-2 text-center">Sharing coming soon</small>
                        </div>
                    </div>

                    <!-- QR Code Card for Authenticated Users -->
                    <div sec:authorize="isAuthenticated()" th:if="${event.userRsvpStatus}" class="card mb-3">
                        <div class="card-body text-center">
                            <h6 class="card-title"><i class="fas fa-qrcode text-primary me-2"></i>Your Ticket</h6>
                            <div>
                                <img th:if="${ticketQrCodeUrl != null}"
                                     th:src="${ticketQrCodeUrl}"
                                     alt="Ticket QR Code"
                                     width="220" height="220"
                                     class="img-fluid rounded border" />
                                <div class="stub-section p-3" th:if="${ticketQrCodeUrl == null}">
                                    <i class="fas fa-qrcode"></i>
                                    <p class="mb-0 small">QR not available</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Event QR Code (General) -->
                    <div class="card mb-3">
                        <div class="card-body text-center">
                            <h6 class="card-title"><i class="fas fa-qrcode text-primary me-2"></i>Event QR Code</h6>
                            <div>
                                <img th:if="${eventQrCodeUrl != null}"
                                     th:src="${eventQrCodeUrl}"
                                     alt="Event QR Code"
                                     width="220" height="220"
                                     class="img-fluid rounded border" />
                                <div class="stub-section p-3" th:if="${eventQrCodeUrl == null}">
                                    <i class="fas fa-qrcode"></i>
                                    <p class="mb-0 small">QR not available</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Attendees Card for Authenticated Users Only -->
                    <div sec:authorize="isAuthenticated()" class="card">
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Who's Going</h6>
                                <span class="badge bg-primary" th:text="${event.attendeeCount}">0</span>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Show attendees if any exist -->
                            <div th:if="${event.attendees != null and !event.attendees.empty}">
                                <!-- Scrollable container for attendees - replaces the previous limit-based approach -->
                                <!-- This container has a fixed height and shows all attendees with scroll when needed -->
                                <div class="attendee-list-container">
                                    <!-- Render attendees with a hard limit of 250 for performance -->
                                    <div th:each="attendee, iterStat : ${event.attendees}" 
                                         th:if="${iterStat.index < 250}"
                                         class="d-flex align-items-center mb-2">
                                        <span class="attendee-avatar me-2" 
                                              th:text="${#strings.substring(attendee.username, 0, 1).toUpperCase()}">A</span>
                                        <div class="flex-grow-1">
                                            <strong class="d-block small" th:text="${attendee.username}">Username</strong>
                                            <small class="text-muted" 
                                                   th:text="|RSVP'd ${#temporals.format(attendee.rsvpDate, 'MMM d')}|">RSVP'd Jan 5</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Total count indicator - shows when >10 attendees to inform user about scroll -->
                                <!-- Shows limited count when attendees exceed 250, otherwise shows all attendees -->
                                <div th:if="${#lists.size(event.attendees) > 10}" 
                                     class="text-center border-top pt-2 mt-2">
                                    <small class="text-muted">
                                        <span th:if="${#lists.size(event.attendees) <= 250}">
                                            Showing all <span th:text="${#lists.size(event.attendees)}">0</span> attendees (max display: 250)
                                        </span>
                                        <span th:if="${#lists.size(event.attendees) > 250}">
                                            Showing first 250 of <span th:text="${#lists.size(event.attendees)}">0</span> attendees
                                        </span>
                                    </small>
                                </div>
                            </div>
                            
                            <!-- No attendees yet -->
                            <div th:if="${event.attendees == null or event.attendees.empty}"
                                 class="text-center text-muted py-3">
                                <i class="fas fa-user-friends fa-2x mb-2"></i>
                                <p class="mb-0">No attendees yet</p>
                                <small>Be the first to RSVP!</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cancel RSVP Modal -->
        <div class="modal fade" id="cancelModal" tabindex="-1" aria-labelledby="cancelModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelModalLabel">Cancel RSVP</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to cancel your RSVP for this event?</p>
                        <p class="text-muted">
                            <small>You can RSVP again later if spots are available.</small>
                        </p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Keep RSVP</button>
                        <form th:action="@{/rsvp/cancel}" method="post" class="d-inline">
                            <input type="hidden" name="eventId" th:value="${event.eventId}">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-danger">Cancel RSVP</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendees Management Modal (Organiser Only) -->
        <div class="modal fade" id="attendeesModal" tabindex="-1" aria-labelledby="attendeesModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="attendeesModalLabel">
                            <i class="fas fa-users me-2"></i>Event Attendees Management
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Tab Navigation -->
                        <ul class="nav nav-tabs mb-3" id="attendeesTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="rsvps-tab" data-bs-toggle="tab" data-bs-target="#rsvps-pane"
                                        type="button" role="tab" aria-controls="rsvps-pane" aria-selected="true">
                                    <i class="fas fa-calendar-check me-2"></i>RSVPs
                                    <span class="badge bg-secondary ms-2" id="rsvpCount">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="blocked-tab" data-bs-toggle="tab" data-bs-target="#blocked-pane"
                                        type="button" role="tab" aria-controls="blocked-pane" aria-selected="false">
                                    <i class="fas fa-ban me-2"></i>Blocked Users
                                    <span class="badge bg-danger ms-2" id="blockedCount">0</span>
                                </button>
                            </li>
                            <!-- Refunds Tab - Only show for paid events -->
                            <li class="nav-item" role="presentation" th:if="${event.requiresPayment}">
                                <button class="nav-link" id="refunds-tab" data-bs-toggle="tab" data-bs-target="#refunds-pane"
                                        type="button" role="tab" aria-controls="refunds-pane" aria-selected="false">
                                    <i class="fas fa-undo me-2"></i>Refunds (Cancelled/Blocked)
                                    <span class="badge bg-warning ms-2" id="refundsCount">0</span>
                                </button>
                            </li>
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="attendeesTabContent">
                            <!-- RSVPs Tab -->
                            <div class="tab-pane fade show active" id="rsvps-pane" role="tabpanel" aria-labelledby="rsvps-tab">
                                <!-- Search bar -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <input type="text" class="form-control" placeholder="Search by username or email..."
                                                   id="attendeesSearchInput">
                                            <button class="btn btn-outline-secondary" type="button" onclick="searchAttendees()">
                                                <i class="fas fa-search"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" type="button" onclick="clearAttendeeSearch()" title="Clear search">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Loading spinner -->
                                <div id="attendeesLoading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Attendees table (hidden initially) -->
                                <div id="attendeesContent" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Email</th>
                                                    <th>RSVP Date</th>
                                                    <th>Payment Status</th>
                                                    <th>Delete RSVP <i class="fas fa-circle-question text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Removes user's RSVP for this event. User can RSVP again after."></i></th>
                                                    <th>Block RSVP <i class="fas fa-circle-question text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Blocking a user removes their current RSVP from this event and prevents them from RSVPing again. They can still view the event."></i></th>
                                                </tr>
                                            </thead>
                                            <tbody id="attendeesTableBody">
                                                <!-- Populated via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination controls -->
                                    <nav id="attendeesPagination">
                                        <ul class="pagination justify-content-center">
                                            <!-- Populated via JavaScript -->
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Empty state -->
                                <div id="attendeesEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No attendees yet</p>
                                </div>
                            </div>

                            <!-- Blocked Users Tab -->
                            <div class="tab-pane fade" id="blocked-pane" role="tabpanel" aria-labelledby="blocked-tab">
                                <!-- Loading spinner -->
                                <div id="blockedLoading" class="text-center py-5">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Blocked users table (hidden initially) -->
                                <div id="blockedContent" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Email</th>
                                                    <th>Blocked Date</th>
                                                    <th>Unblock <i class="fas fa-circle-question text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Allows user to RSVP again if capacity exists, but their original RSVP is not reinstated."></i></th>
                                                </tr>
                                            </thead>
                                            <tbody id="blockedTableBody">
                                                <!-- Populated via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination controls -->
                                    <nav id="blockedPagination">
                                        <ul class="pagination justify-content-center">
                                            <!-- Populated via JavaScript -->
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Empty state -->
                                <div id="blockedEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-user-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No blocked users</p>
                                </div>
                            </div>

                            <!-- Refunds Tab -->
                            <div class="tab-pane fade" id="refunds-pane" role="tabpanel" th:if="${event.requiresPayment}">
                                <!-- Loading spinner -->
                                <div id="refundsLoading" class="text-center py-5">
                                    <div class="spinner-border text-warning" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>

                                <!-- Refunds table (hidden initially) -->
                                <div id="refundsContent" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Email</th>
                                                    <th>Cancelled Date</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Refund Status</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="refundsTableBody">
                                                <!-- Populated via JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Pagination controls -->
                                    <nav id="refundsPagination">
                                        <ul class="pagination justify-content-center">
                                            <!-- Populated via JavaScript -->
                                        </ul>
                                    </nav>
                                </div>

                                <!-- Empty state -->
                                <div id="refundsEmpty" class="text-center py-5" style="display: none;">
                                    <i class="fas fa-hand-holding-usd fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No cancelled RSVPs requiring refunds</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lightbox Modal for Full-Size Image View -->
        <div id="lightbox" class="lightbox">
            <button class="lightbox-close" onclick="closeLightbox()">
                <i class="fas fa-times"></i>
            </button>
            <button class="lightbox-nav prev" onclick="navigateLightbox(-1)">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="lightbox-nav next" onclick="navigateLightbox(1)">
                <i class="fas fa-chevron-right"></i>
            </button>
            <div class="lightbox-content">
                <img id="lightboxImage" class="lightbox-image" src="" alt="">
                <div id="lightboxCaption" class="lightbox-caption"></div>
            </div>
        </div>

    </main>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            // Initialize Bootstrap tooltips
            document.addEventListener('DOMContentLoaded', function() {
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });
            });

            const eventId = /*[[${event.eventId}]]*/ null;
            let currentAttendeesPage = 0;
            let totalAttendeesPages = 0;
            let currentBlockedPage = 0;
            let currentRefundsPage = 0;
            let totalRefundsPages = 0;
            let totalBlockedPages = 0;
            let currentAttendeesSearch = '';

            function openAttendeesModal() {
                const modal = new bootstrap.Modal(document.getElementById('attendeesModal'));
                modal.show();

                // Load all tabs
                loadAttendees(0, '');
                loadBlockedUsers(0);

                // Load refunds tab if it exists (paid events only)
                if (document.getElementById('refunds-tab')) {
                    loadCancelledRSVPs(0);
                }

                // Setup tab change event listeners
                document.getElementById('rsvps-tab').addEventListener('click', () => {
                    loadAttendees(currentAttendeesPage, currentAttendeesSearch);
                });

                document.getElementById('blocked-tab').addEventListener('click', () => {
                    loadBlockedUsers(currentBlockedPage);
                });

                // Setup refunds tab listener if it exists
                const refundsTab = document.getElementById('refunds-tab');
                if (refundsTab) {
                    refundsTab.addEventListener('click', () => {
                        loadCancelledRSVPs(currentRefundsPage);
                    });
                }

                // Setup Enter key for search
                document.getElementById('attendeesSearchInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        searchAttendees();
                    }
                });
            }

            function loadAttendees(page, searchTerm = '') {
                document.getElementById('attendeesLoading').style.display = 'block';
                document.getElementById('attendeesContent').style.display = 'none';
                document.getElementById('attendeesEmpty').style.display = 'none';

                currentAttendeesSearch = searchTerm;

                const url = `/api/events/${eventId}/attendees?page=${page}&size=20&search=${encodeURIComponent(searchTerm)}`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        currentAttendeesPage = data.currentPage;
                        totalAttendeesPages = data.totalPages;

                        // Update count badge
                        document.getElementById('rsvpCount').textContent = data.totalElements || 0;

                        if (data.attendees.length === 0) {
                            document.getElementById('attendeesLoading').style.display = 'none';
                            document.getElementById('attendeesEmpty').style.display = 'block';
                            return;
                        }

                        renderAttendeesTable(data.attendees);
                        renderAttendeesPagination();

                        document.getElementById('attendeesLoading').style.display = 'none';
                        document.getElementById('attendeesContent').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading attendees:', error);
                        alert('Failed to load attendees');
                    });
            }

            function renderAttendeesTable(attendees) {
                const tbody = document.getElementById('attendeesTableBody');

                let allRows = '';
                attendees.forEach(attendee => {
                    const rsvpDate = new Date(attendee.rsvpDate).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    // Determine payment status badge
                    let paymentBadge = '';
                    if (!attendee.eventPrice || attendee.eventPrice < 0.05) {
                        // Free event
                        paymentBadge = '<span class="badge bg-secondary">Free Event</span>';
                    } else {
                        // Paid event - check payment status
                        if (attendee.paymentStatus === 'paid') {
                            paymentBadge = '<span class="badge bg-success">Paid</span>';
                        } else {
                            paymentBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                        }
                    }

                    allRows += `
                        <tr>
                            <td>${attendee.username}</td>
                            <td>${attendee.email}</td>
                            <td>${rsvpDate}</td>
                            <td>${paymentBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="cancelAttendeeRsvp(${attendee.userId}, '${attendee.username}')">
                                    <i class="fas fa-times me-1"></i>Delete
                                </button>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning"
                                        onclick="blockAttendee(${attendee.userId}, '${attendee.username}')">
                                    <i class="fas fa-ban me-1"></i>Block
                                </button>
                            </td>
                        </tr>
                    `;
                });

                // Set all rows at once
                tbody.innerHTML = allRows;

                // Initialize tooltips for dynamically created buttons
                var tooltipTriggerList = [].slice.call(tbody.querySelectorAll('[data-bs-toggle="tooltip"]'));
                tooltipTriggerList.forEach(function (el) {
                    new bootstrap.Tooltip(el);
                });
            }

            function searchAttendees() {
                const searchTerm = document.getElementById('attendeesSearchInput').value;
                loadAttendees(0, searchTerm);
            }

            function clearAttendeeSearch() {
                document.getElementById('attendeesSearchInput').value = '';
                loadAttendees(0, '');
            }

            function renderAttendeesPagination() {
                const pagination = document.getElementById('attendeesPagination').querySelector('ul');
                pagination.innerHTML = '';

                // Previous button
                const prevDisabled = currentAttendeesPage === 0 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" onclick="loadAttendees(${currentAttendeesPage - 1}, '${currentAttendeesSearch}'); return false;">
                            Previous
                        </a>
                    </li>
                `;

                // Page info
                pagination.innerHTML += `
                    <li class="page-item disabled">
                        <span class="page-link">
                            Page ${currentAttendeesPage + 1} of ${totalAttendeesPages}
                        </span>
                    </li>
                `;

                // Next button
                const nextDisabled = currentAttendeesPage >= totalAttendeesPages - 1 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" onclick="loadAttendees(${currentAttendeesPage + 1}, '${currentAttendeesSearch}'); return false;">
                            Next
                        </a>
                    </li>
                `;
            }

            function cancelAttendeeRsvp(userId, username) {
                if (!confirm(`Are you sure you want to delete the RSVP for ${username}?`)) {
                    return;
                }

                fetch(`/api/events/${eventId}/attendees/${userId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadAttendees(currentAttendeesPage, currentAttendeesSearch); // Reload current page with search
                        } else {
                            alert(data.error || 'Failed to cancel RSVP');
                        }
                    })
                    .catch(error => {
                        console.error('Error cancelling RSVP:', error);
                        alert('Failed to cancel RSVP');
                    });
            }

            function blockAttendee(userId, username) {
                if (!confirm(`Are you sure you want to block ${username} from RSVPing to this event? This will delete their RSVP and prevent them from RSVPing again.`)) {
                    return;
                }

                fetch(`/api/events/${eventId}/attendees/${userId}/block`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadAttendees(currentAttendeesPage, currentAttendeesSearch); // Reload attendees with search
                            loadBlockedUsers(0); // Reload blocked users from first page
                        } else {
                            alert(data.error || 'Failed to block user');
                        }
                    })
                    .catch(error => {
                        console.error('Error blocking user:', error);
                        alert('Failed to block user');
                    });
            }

            // Blocked users functions
            function loadBlockedUsers(page) {
                document.getElementById('blockedLoading').style.display = 'block';
                document.getElementById('blockedContent').style.display = 'none';
                document.getElementById('blockedEmpty').style.display = 'none';

                fetch(`/api/events/${eventId}/blocked?page=${page}&size=20`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        currentBlockedPage = data.currentPage;
                        totalBlockedPages = data.totalPages;

                        // Update count badge
                        document.getElementById('blockedCount').textContent = data.totalElements || 0;

                        if (data.blockedUsers.length === 0) {
                            document.getElementById('blockedLoading').style.display = 'none';
                            document.getElementById('blockedEmpty').style.display = 'block';
                            return;
                        }

                        renderBlockedTable(data.blockedUsers);
                        renderBlockedPagination();

                        document.getElementById('blockedLoading').style.display = 'none';
                        document.getElementById('blockedContent').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading blocked users:', error);
                        alert('Failed to load blocked users');
                    });
            }

            function renderBlockedTable(blockedUsers) {
                const tbody = document.getElementById('blockedTableBody');
                tbody.innerHTML = '';

                blockedUsers.forEach(blocked => {
                    const blockedDate = new Date(blocked.blockedDate).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    const row = `
                        <tr>
                            <td>${blocked.username}</td>
                            <td>${blocked.email}</td>
                            <td>${blockedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-success"
                                        onclick="unblockUser(${blocked.userId}, '${blocked.username}')">
                                    <i class="fas fa-check me-1"></i>Unblock
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function renderBlockedPagination() {
                const pagination = document.getElementById('blockedPagination').querySelector('ul');
                pagination.innerHTML = '';

                // Previous button
                const prevDisabled = currentBlockedPage === 0 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" onclick="loadBlockedUsers(${currentBlockedPage - 1}); return false;">
                            Previous
                        </a>
                    </li>
                `;

                // Page info
                pagination.innerHTML += `
                    <li class="page-item disabled">
                        <span class="page-link">
                            Page ${currentBlockedPage + 1} of ${totalBlockedPages}
                        </span>
                    </li>
                `;

                // Next button
                const nextDisabled = currentBlockedPage >= totalBlockedPages - 1 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" onclick="loadBlockedUsers(${currentBlockedPage + 1}); return false;">
                            Next
                        </a>
                    </li>
                `;
            }

            function unblockUser(userId, username) {
                if (!confirm(`Are you sure you want to unblock ${username}? They will be able to RSVP to this event again.`)) {
                    return;
                }

                fetch(`/api/events/${eventId}/blocked/${userId}/unblock`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadBlockedUsers(currentBlockedPage); // Reload blocked users
                        } else {
                            alert(data.error || 'Failed to unblock user');
                        }
                    })
                    .catch(error => {
                        console.error('Error unblocking user:', error);
                        alert('Failed to unblock user');
                    });
            }

            // Refunds Tab Functions
            function loadCancelledRSVPs(page) {
                document.getElementById('refundsLoading').style.display = 'block';
                document.getElementById('refundsContent').style.display = 'none';
                document.getElementById('refundsEmpty').style.display = 'none';

                const url = `/api/events/${eventId}/cancelled-rsvps?page=${page}&size=20`;
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            alert(data.error);
                            return;
                        }

                        currentRefundsPage = data.currentPage;
                        totalRefundsPages = data.totalPages;

                        // Update count badge
                        document.getElementById('refundsCount').textContent = data.totalElements || 0;

                        if (data.cancelledRsvps.length === 0) {
                            document.getElementById('refundsLoading').style.display = 'none';
                            document.getElementById('refundsEmpty').style.display = 'block';
                            return;
                        }

                        renderRefundsTable(data.cancelledRsvps);
                        renderRefundsPagination();

                        document.getElementById('refundsLoading').style.display = 'none';
                        document.getElementById('refundsContent').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error loading cancelled RSVPs:', error);
                        alert('Failed to load cancelled RSVPs');
                    });
            }

            function renderRefundsTable(cancelledRsvps) {
                const tbody = document.getElementById('refundsTableBody');
                tbody.innerHTML = '';

                cancelledRsvps.forEach(cr => {
                    const cancelledDate = new Date(cr.cancelledAt).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Determine type badge color
                    let typeBadgeClass = 'bg-info';
                    if (cr.displayBadge.includes('Blocked')) {
                        typeBadgeClass = 'bg-danger';
                    } else if (cr.displayBadge.includes('Organiser')) {
                        typeBadgeClass = 'bg-warning text-dark';
                    }

                    // Determine refund action button/badge
                    let refundAction = '';
                    if (cr.refundStatus === 'refunded') {
                        const refundedDate = new Date(cr.refundedAt).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        refundAction = `<span class="badge bg-success">Refunded ✓</span><br>
                                       <small class="text-muted">${refundedDate}</small>`;
                    } else if (cr.refundStatus === 'failed') {
                        refundAction = `<span class="badge bg-danger">Refund Failed</span><br>
                                       <button class="btn btn-sm btn-warning mt-1"
                                               onclick="refundPayment(${cr.id}, '${cr.username}', ${cr.amountPaid})">
                                           <i class="fas fa-redo me-1"></i>Retry
                                       </button>`;
                    } else if (cr.paymentStatus === 'paid') {
                        refundAction = `<button class="btn btn-sm btn-warning"
                                               onclick="refundPayment(${cr.id}, '${cr.username}', ${cr.amountPaid})">
                                           <i class="fas fa-undo me-1"></i>Refund Payment
                                       </button>`;
                    } else {
                        refundAction = '<span class="text-muted">No payment</span>';
                    }

                    const row = `
                        <tr>
                            <td>${cr.username}</td>
                            <td>${cr.email}</td>
                            <td>${cancelledDate}</td>
                            <td><span class="badge ${typeBadgeClass}">${cr.displayBadge}</span></td>
                            <td>$${cr.amountPaid ? cr.amountPaid.toFixed(2) : '0.00'}</td>
                            <td>${cr.refundStatus ? cr.refundStatus.charAt(0).toUpperCase() + cr.refundStatus.slice(1) : 'Pending'}</td>
                            <td>${refundAction}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }

            function renderRefundsPagination() {
                const pagination = document.getElementById('refundsPagination').querySelector('ul');
                pagination.innerHTML = '';

                // Previous button
                const prevDisabled = currentRefundsPage === 0 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${prevDisabled}">
                        <a class="page-link" href="#" onclick="loadCancelledRSVPs(${currentRefundsPage - 1}); return false;">
                            Previous
                        </a>
                    </li>
                `;

                // Page info
                pagination.innerHTML += `
                    <li class="page-item disabled">
                        <span class="page-link">
                            Page ${currentRefundsPage + 1} of ${totalRefundsPages}
                        </span>
                    </li>
                `;

                // Next button
                const nextDisabled = currentRefundsPage >= totalRefundsPages - 1 ? 'disabled' : '';
                pagination.innerHTML += `
                    <li class="page-item ${nextDisabled}">
                        <a class="page-link" href="#" onclick="loadCancelledRSVPs(${currentRefundsPage + 1}); return false;">
                            Next
                        </a>
                    </li>
                `;
            }

            function refundPayment(cancelledRsvpId, username, amount) {
                // Show confirmation dialog
                if (!confirm(`Refund $${amount.toFixed(2)} to ${username}?\n\nThis action cannot be undone.`)) {
                    return;
                }

                fetch(`/api/events/${eventId}/cancelled-rsvps/${cancelledRsvpId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Refund processed successfully!');
                            loadCancelledRSVPs(currentRefundsPage); // Reload current page
                        } else {
                            alert(data.error || 'Failed to process refund');
                        }
                    })
                    .catch(error => {
                        console.error('Error processing refund:', error);
                        alert('Failed to process refund');
                    });
            }

            function exportAttendees(eventId) {
                // Trigger CSV download
                window.location.href = '/api/events/' + eventId + '/attendees/export';
            }

            // ========================================
            // Photo Gallery Functions
            // ========================================

            let isOrganizer = /*[[${event.createdByUsername == #authentication.name or #authorization.expression('hasRole(''ADMIN'')')}]]*/ false;
            let didUserRsvp = /*[[${didUserRsvp}]]*/ false;

            // Load photos on page load
            document.addEventListener('DOMContentLoaded', function() {
                if (didUserRsvp || isOrganizer) {
                    loadPhotos();
                    setupPhotoUpload();
                }
            });

            function loadPhotos() {
                fetch(`/api/events/${eventId}/photos`)
                    .then(response => response.json())
                    .then(data => {
                        const gallery = document.getElementById('photoGallery');
                        const emptyState = document.getElementById('emptyState');
                        const photoCountBadge = document.getElementById('photoCount');

                        // Update photo count badge
                        photoCountBadge.textContent = `${data.count}/20 photos`;

                        if (data.photos.length === 0) {
                            // Show empty state
                            gallery.innerHTML = '';
                            emptyState.style.display = 'block';
                        } else {
                            // Hide empty state and render photos
                            emptyState.style.display = 'none';
                            renderPhotos(data.photos);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading photos:', error);
                    });
            }

            function renderPhotos(photos) {
                const gallery = document.getElementById('photoGallery');

                gallery.innerHTML = `
                    <div class="photo-grid">
                        ${photos.map(photo => `
                            <div class="photo-item" data-photo-id="${photo.id}">
                                <img src="${photo.thumbnailUrl}"
                                     alt="${photo.originalFilename}"
                                     onerror="this.src='/images/placeholder.jpg'; this.onerror=null;"
                                     onclick="openLightbox('${photo.photoUrl}', '${photo.originalFilename}')"
                                     style="cursor: pointer;">
                                <div class="mt-2 d-flex gap-1 justify-content-center">
                                    <a href="/api/events/[[${event.eventId}]]/photos/${photo.id}/download"
                                       download="${photo.originalFilename}"
                                       class="btn btn-sm btn-primary"
                                       onclick="event.stopPropagation();">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    ${isOrganizer ? `
                                        <button class="btn btn-sm btn-danger"
                                                onclick="deletePhoto(${photo.id}); event.stopPropagation();"
                                                title="Delete photo">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            function setupPhotoUpload() {
                const photoInput = document.getElementById('photoInput');
                const uploadArea = document.getElementById('uploadArea');

                if (!photoInput || !uploadArea || !isOrganizer) {
                    return;
                }

                // File input change handler
                photoInput.addEventListener('change', function(e) {
                    handleFiles(e.target.files);
                });

                // Drag and drop handlers
                uploadArea.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', function(e) {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    handleFiles(e.dataTransfer.files);
                });
            }

            function handleFiles(files) {
                if (files.length === 0) return;

                // Client-side validation
                const maxSize = 5 * 1024 * 1024; // 5MB
                const validTypes = ['image/jpeg', 'image/png'];
                const validFiles = [];

                for (let file of files) {
                    if (!validTypes.includes(file.type)) {
                        alert(`${file.name}: Only JPEG and PNG images are allowed`);
                        continue;
                    }
                    if (file.size > maxSize) {
                        alert(`${file.name}: File size exceeds 5MB limit`);
                        continue;
                    }
                    validFiles.push(file);
                }

                if (validFiles.length === 0) return;

                // Upload files
                uploadPhotos(validFiles);
            }

            function uploadPhotos(files) {
                const formData = new FormData();

                for (let file of files) {
                    formData.append('files', file);
                }

                // Show uploading state
                const uploadArea = document.getElementById('uploadArea');
                const originalContent = uploadArea.innerHTML;
                uploadArea.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Uploading...</span>
                    </div>
                    <p class="mt-2">Uploading ${files.length} photo${files.length > 1 ? 's' : ''}...</p>
                `;

                fetch(`/api/events/${eventId}/photos/upload`, {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Restore upload area
                    uploadArea.innerHTML = originalContent;

                    // Reset file input
                    document.getElementById('photoInput').value = '';

                    if (data.success || data.message.includes('successfully')) {
                        // Reload photos
                        loadPhotos();

                        // Show success message
                        alert(data.message);
                    } else {
                        // Show error message
                        alert(data.error || data.message);
                    }
                })
                .catch(error => {
                    // Restore upload area
                    uploadArea.innerHTML = originalContent;
                    document.getElementById('photoInput').value = '';

                    console.error('Error uploading photos:', error);
                    alert('Failed to upload photos. Please try again.');
                });
            }

            function deletePhoto(photoId) {
                if (!confirm('Are you sure you want to delete this photo?')) {
                    return;
                }

                fetch(`/api/events/${eventId}/photos/${photoId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload photos
                        loadPhotos();
                    } else {
                        alert(data.error || 'Failed to delete photo');
                    }
                })
                .catch(error => {
                    console.error('Error deleting photo:', error);
                    alert('Failed to delete photo. Please try again.');
                });
            }

            // ========================================
            // Lightbox Functions
            // ========================================

            let currentPhotos = [];
            let currentPhotoIndex = 0;

            function openLightbox(photoUrl, filename) {
                // Get all photos from the current gallery
                const photos = Array.from(document.querySelectorAll('.photo-item')).map(item => {
                    const img = item.querySelector('img');
                    return {
                        url: img.getAttribute('onclick').match(/'([^']+)'/)[1], // Extract photoUrl from onclick
                        filename: img.getAttribute('alt')
                    };
                });

                currentPhotos = photos;
                currentPhotoIndex = photos.findIndex(p => p.url === photoUrl);

                showLightboxPhoto();
            }

            function showLightboxPhoto() {
                const lightbox = document.getElementById('lightbox');
                const image = document.getElementById('lightboxImage');
                const caption = document.getElementById('lightboxCaption');
                const prevBtn = document.querySelector('.lightbox-nav.prev');
                const nextBtn = document.querySelector('.lightbox-nav.next');

                // Get current photo
                const photo = currentPhotos[currentPhotoIndex];

                // Update image and caption
                image.src = photo.url;
                image.alt = photo.filename;
                caption.textContent = `${photo.filename} (${currentPhotoIndex + 1} / ${currentPhotos.length})`;

                // Update navigation buttons
                prevBtn.disabled = currentPhotoIndex === 0;
                nextBtn.disabled = currentPhotoIndex === currentPhotos.length - 1;

                // Show lightbox
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            function closeLightbox() {
                const lightbox = document.getElementById('lightbox');
                lightbox.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }

            function navigateLightbox(direction) {
                currentPhotoIndex += direction;

                // Clamp to valid range
                if (currentPhotoIndex < 0) {
                    currentPhotoIndex = 0;
                }
                if (currentPhotoIndex >= currentPhotos.length) {
                    currentPhotoIndex = currentPhotos.length - 1;
                }

                showLightboxPhoto();
            }

            // Keyboard navigation for lightbox
            document.addEventListener('keydown', function(e) {
                const lightbox = document.getElementById('lightbox');
                if (!lightbox.classList.contains('active')) return;

                switch(e.key) {
                    case 'Escape':
                        closeLightbox();
                        break;
                    case 'ArrowLeft':
                        if (currentPhotoIndex > 0) navigateLightbox(-1);
                        break;
                    case 'ArrowRight':
                        if (currentPhotoIndex < currentPhotos.length - 1) navigateLightbox(1);
                        break;
                }
            });

            // Close lightbox when clicking outside the image
            document.addEventListener('click', function(e) {
                const lightbox = document.getElementById('lightbox');
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });

        </script>
    </th:block>
</body>

</html>
# ========================================
# MySQL Production Configuration with Flyway
# ========================================
# This configuration uses Flyway for automated database schema management.
# NOTE: This applies ONLY to prod profile, NOT dev profile (dev uses H2 in-memory).
#
# ========================================
# PREREQUISITES (Required Before Starting App)
# ========================================
# 1. MySQL server must be running
# 2. Database 'webapp' must be created manually: CREATE DATABASE webapp;
#    - Flyway connects to jdbc:mysql://localhost:3306/webapp BEFORE running migrations
#    - If 'webapp' doesn't exist, connection fails before migrations execute
#    - Database name must be in JDBC URL path for Flyway to execute SQL over network
#
# ========================================
# HOW IT WORKS
# ========================================
# OLD PROCESS (Manual):
#   1. Start MySQL server
#   2. Manual: CREATE DATABASE webapp;
#   3. Manual: Run data-prod-schema.sql in MySQL CLI
#   4. Start app
#
# NEW PROCESS (Flyway Automated):
#   1. Start MySQL server
#   2. Manual: CREATE DATABASE webapp;
#   3. Start app with --spring.profiles.active=prod
#   4. Flyway automatically creates all tables via JDBC connection
#
# ========================================
# STARTUP SEQUENCE
# ========================================
# 1. Spring Boot connects to jdbc:mysql://localhost:3306/webapp
# 2. Flyway runs BEFORE Hibernate validation
# 3. Flyway checks migration files vs flyway_schema_history table
# 4. Flyway executes any pending migrations (V1 → V2 → V3)
# 5. Hibernate validates schema matches entity classes exactly
#
# ========================================
# MIGRATION FILES
# ========================================
# Location: src/main/resources/db/migration/
# - V1__initial_schema.sql: Core tables (users, categories, events, rsvp)
# - V2__add_keywords_and_blocking.sql: Keywords and blocking features
# - V3__add_payments_and_reviews.sql: Payments and reviews
#
# Flyway tracks applied migrations in 'flyway_schema_history' table.
# If no new migration files exist, Flyway does nothing on startup.
#
# ========================================
# SCHEMA VALIDATION & CHANGES
# ========================================
# Manual DB Changes:
# - Bypass Flyway (Flyway only checks migration files, not actual schema)
# - Get caught by Hibernate 'validate' mode on startup (will throw error)
#
# Proper Entity/Schema Change Workflow:
# 1. Modify entity classes (e.g., add new field)
# 2. Create new migration file (e.g., V4__add_new_field.sql with ALTER TABLE)
# 3. Start app - Flyway applies new migration automatically
# 4. Hibernate validates schema matches entities
#
# ========================================
# LEGACY FILES
# ========================================
# - data-prod-schema.sql is now orphaned/backup code
# - Flyway manages schema going forward via migration files ONLY
# - Keep data-prod-schema.sql as reference but do NOT run it manually
#
# ========================================
# DATAINITIALIZER
# ========================================
# - DataInitializer.java creates sample data (33 events, users, categories, etc.)
# - Run it once initially, then disable with: @Profile("nonexistent-profile")
# - MySQL persistence means data survives app restarts (unlike H2 in-memory)

spring.datasource.url=jdbc:mysql://${DB_HOST:localhost}:${DB_PORT:3306}/${DB_NAME:webapp}
spring.datasource.username=${DB_USER:root}
spring.datasource.password=
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

# MySQL Dialect
spring.jpa.database-platform=org.hibernate.dialect.MySQLDialect

# Connection pool resilience
spring.datasource.hikari.connection-timeout=60000
spring.datasource.hikari.initialization-fail-timeout=60000

# Schema Management: NEVER use 'update' in production - always use 'validate'
# validate = Read-only schema validation, ensures entities match database exactly
spring.jpa.hibernate.ddl-auto=validate

# SQL Script Management: NEVER run SQL scripts automatically in production
# never = Spring Boot ignores all SQL scripts, relies on manual schema management
spring.sql.init.mode=never

# Disable H2 console (not needed for MySQL)
spring.h2.console.enabled=false

# ========================================
# Flyway Configuration
# ========================================
# Flyway uses Spring Boot auto-configuration
# Migration files are located in src/main/resources/db/migration/
# Flyway tracks applied migrations in flyway_schema_history table
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=true
spring.flyway.locations=classpath:db/migration
spring.flyway.validate-on-migrate=false
spring.flyway.depends-on=entityManagerFactory

# ========================================
# Circular Dependency Fix for Spring Boot 3.x
# ========================================
spring.jpa.defer-datasource-initialization=false
spring.main.allow-circular-references=true

# ========================================
# Stripe Production Configuration
# ========================================
# Base URL for Stripe redirects (production VM URL)
# Set via environment variable for security
app.base.url=${APP_BASE_URL:http://localhost:8080}

# Stripe webhook secret for production
# Get from Stripe Dashboard: https://dashboard.stripe.com/webhooks
stripe.webhook.secret=${STRIPE_WEBHOOK_SECRET_PROD:}

# ========================================
# Google Cloud Storage Configuration
# ========================================
# GCS bucket name for photo storage
# SETUP REQUIRED:
# 1. Create GCS bucket: gsutil mb gs://eventhub-photos-prod
# 2. Set bucket to public-read (optional): gsutil iam ch allUsers:objectViewer gs://eventhub-photos-prod
# 3. VM uses service account credentials automatically (Application Default Credentials)
# 4. For local testing with prod profile: Set GOOGLE_APPLICATION_CREDENTIALS env variable
#
# BUCKET NAMING:
# - Must be globally unique across all GCP projects
# - Use format: {project-name}-photos-{environment}
# - Replace with your actual bucket name below
gcs.bucket.name=eventhub-photos-prod